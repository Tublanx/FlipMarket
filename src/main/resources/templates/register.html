<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ko">

<head>
	<meta charset="UTF-8">
	<title>FlipMarket - 회원가입</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body class="bg-gray-50 flex items-center justify-center min-h-screen px-4">

	<div class="w-full max-w-lg bg-white p-8 rounded-2xl shadow-lg">
		<h2 class="text-2xl font-bold mb-6 text-center text-blue-600">FlipMarket 회원가입</h2>

		<form id="registerForm">

			<!-- 이메일 -->
			<div class="mb-4">
				<label for="email" class="block text-sm text-gray-700 mb-1">이메일</label>
				<div class="flex gap-2">
					<input type="text" name="email" id="email" required
						class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
						placeholder="이메일 입력" />
					<button type="button" onclick="checkEmailDuplicate(event)" id="emailOverlay"
						class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-md text-xs">중복확인</button>
				</div>
			</div>

			<!-- 비밀번호 -->
			<div class="mb-4">
				<label for="pwd" class="block text-sm text-gray-700 mb-1">비밀번호</label>
				<input type="password" name="pwd" id="pwd" required
					class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					placeholder="비밀번호 입력" />
			</div>

			<!-- 이름 -->
			<div class="mb-4">
				<label for="name" class="block text-sm text-gray-700 mb-1">이름</label>
				<input type="text" name="name" id="name" required
					class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
					placeholder="이름 입력" />
			</div>

			<!-- 주소 입력 폼 -->
			<div class="mb-4">
				<label class="block text-sm font-medium text-gray-700">주소</label>
				<div class="flex space-x-2">
					<input type="text" id="postcode" class="w-1/3 px-4 py-2 border rounded" placeholder="우편번호" readonly>
					<button type="button" onclick="execDaumPostcode()"
						class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">주소찾기</button>
				</div>
				<input type="text" id="address" class="w-full mt-2 px-4 py-2 border rounded" placeholder="기본 주소"
					readonly>
				<input type="text" id="detailAddress" class="w-full mt-2 px-4 py-2 border rounded" placeholder="상세 주소">

				<span id="addressType" hidden></span>
				<span id="userSelectedType" hidden></span>
				<span id="jibunAddress" hidden></span>
				<span id="buildingName" hidden></span>
			</div>

			<!-- 가입 버튼 -->
			<button type="submit" onclick="register(event);"
				class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 transition">가입하기</button>
		</form>

		<!-- 메인으로 이동 -->
		<div class="mt-6 text-center text-sm text-gray-600">
			<a th:href="@{/}" class="text-blue-600 hover:underline">메인 페이지로 이동</a>
		</div>
	</div>

</html>
<th:block layout:fragment="script">
	<script th:inline="javascript">
		// DAUM API
		function execDaumPostcode() {
			new daum.Postcode({
				oncomplete: function (data) {
					$("#postcode").val(data.zonecode);
					$("#address").val(data.address);
					$("#addressType").text(data.addressType);
					$("#userSelectedType").text(data.userSelectedType);
					$("#jibunAddress").text(data.jibunAddress);
					$("#buildingName").text(data.buildingNAme);
					$("#detailAddress").focus();
				}
			}).open();
		}

		// 이메일 중복체크 로직
		function checkEmailDuplicate() {
			event.preventDefault();

			const email = $("#email").val();

			if (email == "") {
				alert("이메일을 입력해주세요.");
				$("#email").focus();
				return false;
			}

			if (email.length < 5 || email.length > 20) {
				alert("이메일을 5자 이상 20자 이하로 입력해주세요.");
				$("#email").focus();
				return false;
			}

			$.ajax({
				type: "GET",
				url: "/api/overlap/emailRegister",
				data: {"email": email},
				dataType: "JSON",

				success: function (result) {
					if (result.result == "0") {
						if (confirm("사용 가능한 이메일입니다.")) {
							$("#email").attr("readonly", true);
							$("#emailOverlay").attr("disabled", true);
							$("#emailOverlay").attr("display", "none");
						}

						return false;
					} else if (result.result == "1") {
						alert("이미 사용중인 이메일입니다.");
						$("#email").focus();
					} else {
						alert("Server Error");
					}
				},
				error: function (request, status, error) {
					alert("이메일 중복체크 에러\n code: " + request.status + "\n error: " + error);
				}
			});
		}

		// 회원가입 로직
		function register(event) {
			event.preventDefault();

			const email = $("#email").val();
			const pwd = $("#pwd").val();
			const name = $("#name").val();
			// 우편번호
			const zonecode = $("#postcode").val();
			// 도로명 주소
			const address = $("#address").val();
			// 세부 주소
			const detailAddress = $("#detailAddress").val();
			// 주소 타입 (R: 도로명, J: 지번)
			const userSelectedType = $("#userSelectedType").text();
			// 지번 주소
			const jibunAddress = $("#jibunAddress").text();
			// 건물명
			const buildingName = $("#buildingName").text();

			const data = {
				email: email,
				pwd: pwd,
				name: name,
				zonecode: zonecode,
				address: address,
				detailAddress: detailAddress,
				userSelectedType: userSelectedType,
				jibunAddress: jibunAddress,
				buildingName: buildingName,
			};

			if (!$("#emailOverlay").is(":disabled")) {
				alert("이메일 중복체크를 해주세요.");
				return false;
			}

			if (pwd == "" || pwd.length < 8 || pwd.length > 20) {
				alert("비밀번호는 8자 이상 20자 이하로 입력해주세요.");
				$("#pwd").focus();
				return false;
			}

			if (name == "") {
				alert("이름을 입력해주세요.");
				$("#name").focus();
				return false;
			}
			
			if (zonecode == "") {
				alert("주소를 입력해주세요.");
				return false;
			}
			
			if (detailAddress == "") {
				alert("상세 주소를 입력해주세요.");
				$("#detailAddress").focus();
				return false;
			}

			$.ajax({
				type: "POST",
				url: "/api/register",
				data: JSON.stringify(data),
				contentType: "application/json",

				success: function (result) {
					alert("회원가입이 완료되었습니다.");
					window.location.href = "/login";
				},
				error: function (request, status, error) {
					alert("회원가입 오류\n code: " + request.status + "\n error: " + error);
				}
			});
		}
	</script>
</th:block>