<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <head>
        <title>회원가입</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <body>
		<form id="registerForm">
		  <input type="text" id="id" name="id" placeholder="id" /> 
		  <input type="button" id="idOverlay" onclick="idCheck()" value="중복 체크"/><br>
		  <input type="password" id="pwd" name="pwd" placeholder="pwd" /><br>
		  <input type="text" id="name" name="name" placeholder="name" /><br>
		  <input type="number" id="age" name="age" placeholder="age" /><br>
		  <input type="tel" id="phoneNum" name="phoneNum" placeholder="phoneNum" /><br>
		  <div><input type="button" onclick="checkValidate(event)" value="Register"/></div>
		</form>
		<form method="get" th:action="@{/main}">
			<div><input type="submit" value="Main"/></div>
		</form>
	</body>
</html>
<th:block layout:fragment="script">
	<script th:inline="javascript">
		function idCheck() {
			const id = $("#id").val();
			if (id == "") {
				alert("아이디는 5자 이상 20자 이하로 입력해주세요.");
				$("#id").focus();
				return false;
			}
			
			if (id.length < 5 || id.length > 20) {
				alert("아이디는 5자 이상 20자 이하로 입력해주세요.");
				$("#id").focus();
				return false;
			}
			
			$.ajax({
				type: "GET",
				url: "/api/overlap/idRegister",
				data: {"id": id},
				dataType: "JSON",
				
				success: function (result) {
					if (result.result == "0") {
						if (confirm("사용 가능한 아이디입니다.")) {
							$("#id").attr("readonly", true);
							$("#idOverlay").attr("disabled", true);
							$("#idOverlay").attr("display", "none");
						}
						
						return false;
					} else if (result.result == "1") {
						alert("이미 사용중인 아이디입니다.");
						$("#id").focus();
					} else {
						alert("Server Error");
					}
				},
				error: function (request, status, error) {
					alert("ajax 에러\n code: " + request.status + "\n error: " + error);
				}
			});
		}
		
		function checkValidate(event) {
			event.preventDefault();
			
			const pwd = $("#pwd").val();
			const name = $("#name").val();
			const age = $("#age").val();
			
			const data = {
				id: $("#id").val(),
				pwd: pwd,
				name: name,
				age: age,
				phoneNum: $("#phoneNum").val()
			};
			
			if (!$("#idOverlay").is(":disabled")) {
				alert("아이디 중복체크를 해주세요.");
				return false;
			}
			
			if (pwd == "" || pwd.length < 8 || pwd.length > 20) {
				alert("비밀번호는 8자 이상 20자 이하로 입력해주세요.");
				$("#pwd").focus();
				return false;
			}
			
			if (name == "") {
				alert("이름을 입력해주세요.");
				return false;
			}
			
			if (age == "") {
				alert("나이를 입력해주세요.");
				return false;
			}
			
			$.ajax({
				type: "POST",
				url: "/api/register",
				data: JSON.stringify(data),
				contentType: "application/json",
				
				success: function (result) {
					alert("회원가입이 완료되었습니다.");
					window.location.href = "/login";
				},
				error: function (request, status, error) {
					alert("회원가입 오류\n code: " + request.status + "\n error: " + error);
				}
			});
		}
	</script>
</th:block>