<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security" lang="ko">

<head>
	<meta charset="UTF-8">
	<title th:text="${product.productName} + ' - 상품 상세'"></title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body class="bg-gray-50 text-gray-800">
	<span id="productNum" th:text="${product.num}" hidden></span>

	<div class="max-w-4xl mx-auto py-10 px-4">
		<!-- 뒤로가기 버튼 -->
		<button onclick="history.back();" class="mb-6 text-blue-600 hover:underline">&larr; 뒤로가기</button>

		<div class="bg-white rounded-lg shadow-lg p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
			<!-- 이미지 -->
			<div>
				<img th:src="@{|/images/${product.imagePath}}" alt="상품 이미지"
					class="w-full h-80 object-contain rounded-md border">
			</div>

			<!-- 상세 정보 -->
			<div class="space-y-4">
				<h1 class="text-2xl font-bold" th:text="${product.productName}"></h1>
				<p class="text-gray-600" th:text="'카테고리: ' + ${product.category}"></p>
				<p class="text-3xl text-green-600 font-semibold" th:text="'₩ ' + ${product.price}"></p>
				<hr>
				<p class="text-sm text-gray-700 whitespace-pre-line" th:text="${product.description}"></p>

				<!-- 수량 선택 -->
				<div class="flex items-center space-x-4">
					<label for="quantity" class="font-medium">수량</label>
					<input type="number" id="quantity" name="quantity" value="1" min="1" max="10"
						class="w-16 text-center border rounded-md">
					<p class="text-gray-500 text-sm" id="stock" th:text="'남은 수량: ' + ${product.stock}"></p>
				</div>

				<!-- 예: 구매하기 버튼 -->
				<div class="pt-4">
					<button onclick="addCart(event);"
						class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
						장바구니에 담기
					</button>
				</div>
			</div>
		</div>
	</div>
</body>

</html>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		function addCart(event) {
			event.preventDefault();

			const productNum = $("#productNum").text();
			const quantity = $("#quantity").val();
			const stock = $("#stock").text();

			const data = {
				productNum: productNum,
				quantity: quantity
			}

			if (quantity > stock) {
				alert("수량이 초과되었습니다.");
				return false;
			}

			$.ajax({
				type: "POST",
				url: "/api/addCart",
				data: JSON.stringify(data),
				contentType: "application/json",

				success: function (result) {
					// 로그아웃 상태일 경우
					if (result.result == "0") {
						alert("로그인이 되어있지 않습니다.");
						window.location.href = "/login";
						return false;
					// 이미 장바구니에 등록되어있을 경우
					} else if (result.result == "2") {
						alert("이미 장바구니에 등록되어있는 상품입니다.");
						return false;
					} else {
						alert("장바구니에 추가되었습니다.");
						window.location.href = "/main";
					}
				},
				error: function (request, status, error) {
					alert("장바구니 추가 오류\ncode: " + request.status + "\nerror: " + error);
				}
			});
		}
	</script>
</th:block>