<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title>회원정보 수정</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">

	<div class="bg-white p-8 rounded-xl shadow-md w-full max-w-md">
		<h2 class="text-2xl font-bold text-center text-blue-600 mb-6">회원정보 수정</h2>

		<span id="num" th:text="${user.num}" hidden></span>
		<span id="originAge" th:text="${user.age}" hidden></span>
		<span id="originEmail" th:text="${user.email}" hidden></span>
		<span id="originPhoneNum" th:text="${user.phoneNum}" hidden></span>

		<!-- 아이디 -->
		<div class="mb-6">
			<label class="block text-sm font-medium text-gray-700 mb-1">아이디</label>
			<div class="flex gap-2">
				<input type="text" id="newEmail" th:value="${user.email}" disabled
					class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100 text-gray-500">
				<button id="edit-username-btn"
					class="text-sm px-3 py-2 bg-yellow-400 text-white rounded hover:bg-yellow-500">
					아이디 변경
				</button>
			</div>
			<button id="save-username-btn" onclick="updateEmail(event);"
				class="mt-2 hidden w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
				아이디 저장
			</button>
		</div>

		<!-- 이름 (읽기 전용) -->
		<div class="mb-6">
			<label class="block text-sm font-medium text-gray-700 mb-1">이름</label>
			<input type="text" th:value="${user.name}" readonly
				class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100 text-gray-500">
		</div>

		<!-- 휴대폰 번호 -->
		<div class="mb-6">
			<label class="block text-sm font-medium text-gray-700 mb-1">휴대폰 번호</label>
			<div class="flex gap-2">
				<input type="tel" id="newPhoneNum" th:value="${user.phoneNum}" disabled
					class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-100 text-gray-500" maxlength="13"
					oninput="formatPhoneNumber(this);">
				<button id="edit-phone-btn"
					class="text-sm px-3 py-2 bg-yellow-400 text-white rounded hover:bg-yellow-500">
					휴대폰 변경
				</button>
			</div>
			<button id="save-phone-btn" onclick="updatePhoneNum(event);"
				class="mt-2 hidden w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
				휴대폰 저장
			</button>
		</div>

		<!-- 비밀번호 변경 -->
		<div class="mb-6">
			<button id="toggle-password-section" class="text-sm text-blue-600 hover:underline">비밀번호 변경</button>
			<div id="password-section" class="mt-3 space-y-3 hidden">
				<div>
					<label class="block text-sm text-gray-600 mb-1">현재 비밀번호</label>
					<input type="password" id="pwd" class="w-full border border-gray-300 rounded-md px-3 py-2">
				</div>
				<div>
					<label class="block text-sm text-gray-600 mb-1">새 비밀번호</label>
					<input type="password" id="newPwd" class="w-full border border-gray-300 rounded-md px-3 py-2">
				</div>
				<div>
					<label class="block text-sm text-gray-600 mb-1">비밀번호 재입력</label>
					<input type="password" id="newPwdReConf" class="w-full border border-gray-300 rounded-md px-3 py-2">
				</div>
				<button class="mt-2 w-full bg-green-500 text-white py-2 rounded hover:bg-green-600"
					onclick="updatePwd(event);">
					비밀번호 저장
				</button>
			</div>
		</div>

		<!-- 버튼들 -->
		<div class="flex justify-between items-center pt-6 border-t">
			<button onclick="location.href='/'" class="text-gray-600 hover:underline">메인으로</button>
			<button id="delete-account-btn" onclick="deleteAccount(event);" class="text-red-600 hover:underline font-medium">회원탈퇴</button>
		</div>
	</div>
</body>

</html>

</html>
<th:block layout:fragment="script">
	<script th:inline="javascript">
		// 아이디 수정 가능하게
		$('#edit-username-btn').click(function () {
			$('#newEmail').prop('disabled', false).removeClass('bg-gray-100 text-gray-500').focus();
			$('#save-username-btn').removeClass('hidden');
		});

		// 휴대폰 수정 가능하게
		$('#edit-phone-btn').click(function () {
			$('#newPhoneNum').prop('disabled', false).removeClass('bg-gray-100 text-gray-500').focus();
			$('#save-phone-btn').removeClass('hidden');
		});

		// 비밀번호 섹션 토글
		$('#toggle-password-section').click(function () {
			$('#password-section').toggleClass('hidden');
		});

		// 휴대폰 번호 입력 시 하이픈 자동 입력 함수
		function formatPhoneNumber(input) {
			let numbers = input.value.replace(/\D/g, ''); // 숫자만 남기기

			if (numbers.length > 11) {
				numbers = numbers.slice(0, 11); // 11자리로 제한
			}

			let formatted = '';
			if (numbers.length <= 3) {
				formatted = numbers;
			} else if (numbers.length <= 7) {
				formatted = numbers.slice(0, 3) + '-' + numbers.slice(3);
			} else {
				formatted = numbers.slice(0, 3) + '-' + numbers.slice(3, 7) + "-" + numbers.slice(7);
			}

			input.value = formatted;
		}

		function updateEmail(event) {
			event.preventDefault();

			const num = $("#num").text();
			const originEmail = $("#originEmail").text();
			const newEmail = $("#newEmail").val();

			const data = {
				num: num,
				email: newEmail,
			}

			if (newEmail == "") {
				alert("변경할 새로운 아이디를 입력해주세요.");
				$("#newEmail").focus();
				return false;
			}

			if (newEmail.length < 5 || newEmail.length > 20) {
				alert("이메일은 5자 이상 20자 이하로 입력해야합니다.");
				$("#email").focus();
				return false;
			}

			if (originEmail == newEmail) {
				alert("기존 이메일과 일치합니다. 다시 입력해주세요.");
				$("#newIEmail").focus();
				return false;
			}

			$.ajax({
				type: "POST",
				url: "/api/mypage/editProfile/updateEmail",
				data: JSON.stringify(data),
				contentType: "application/json",

				success: function (result) {
					alert("이메일 변경 완료되었습니다.");
					location.reload();
				},
				error: function (request, status, error) {
					alert("이메일 변경 오류\n code: " + request.status + "\n error: " + error);
				}
			});
		}

		function updatePhoneNum(event) {
			event.preventDefault();

			const num = $("#num").text();
			const originPhoneNum = $("#originPhoneNum").text();
			const newPhoneNum = $("#newPhoneNum").val();

			const data = {
				num: num,
				phoneNum: newPhoneNum,
			}

			if (newPhoneNum == "") {
				alert("변경할 새로운 휴대폰 번호를 입력해주세요.");
				$("#newPhoneNum").focus();
				return false;
			}

			if (originPhoneNum == newPhoneNum) {
				alert("기존 휴대폰 번호와 일치합니다. 다시 입력해주세요.");
				$("#newPhoneNum").focus();
				return false;
			}

			$.ajax({
				type: "POST",
				url: "/api/mypage/editProfile/updatePhoneNum",
				data: JSON.stringify(data),
				contentType: "application/json",

				success: function (result) {
					alert("휴대폰 번호 변경 완료되었습니다.");
					location.reload();
				},
				error: function (request, status, error) {
					alert("휴대폰 번호 변경 오류\n code: " + request.status + "\n error: " + error);
				}
			});
		}

		function updatePwd(event) {
			event.preventDefault();

			const num = $("#num").text();
			const pwd = $("#pwd").val();
			const newPwd = $("#newPwd").val();
			const newPwdReConf = $("#newPwdReConf").val();

			const data = {
				num: num,
				pwd: pwd,
				newPwd: newPwd
			};

			if (pwd == newPwd) {
				alert("현재 비밀번호와 변경하실 비밀번호가 동일합니다.");
				return false;
			}

			if (newPwd == "" || newPwd.length < 8 || newPwd.length > 20) {
				alert("비밀번호는 8자 이상 20자 이하로 입력해주세요.");
				return false;
			}

			if (newPwd != newPwdReConf) {
				alert("변경하실 비밀번호와 비밀번호 재입력 값이 다릅니다.");
				return false;
			}

			$.ajax({
				type: "POST",
				url: "/api/mypage/editProfile/updatePwd",
				data: JSON.stringify(data),
				contentType: "application/json",

				success: function (result) {
					if (result.result == "0") { // 만약 DB에 있는 사용자의 비밀번호와 현재 비밀번호 입력값이 다를 경우
						alert("현재 비밀번호가 일치하지 않습니다.");
						return false;
					} else if (result.result == "1") { // 정상적으로 입력이 되었을 경우
						alert("비밀번호 변경 완료되었습니다.");
						location.reload();
					} else {
						alert("Server Error");
					}
				},
				error: function (request, status, error) {
					alert("비밀번호 번호 변경 오류\n code: " + request.status + "\n error: " + error);
				}
			});
		}

		function deleteAccount(event) {
			event.preventDefault();

			if (confirm("정말로 회원탈퇴 하시겠습니까? 탈퇴 후에는 복구가 불가능합니다.")) {
				$.ajax({
					type: "POST",
					url: "/api/mypage/editProfile/deleteAccount",
					data: JSON.stringify({userNum: $("#num").text()}),
					contentType: "application/json",

					success: function (result) {
						alert("회원 탈퇴가 완료되었습니다.");
						window.location.href = "/logout";
					},
					error: function (request, status, error) {
						alert("계정 탈퇴 오류\n code: " + request.status + "\n error: " + error);
					}
				})
			} else {
				return false;
			}
		}
	</script>
</th:block>